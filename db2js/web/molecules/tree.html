<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Db2js</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <link href="../jslib/bootstrap-3.3.4/css/bootstrap.css" rel="stylesheet" media="screen">
    <script src="../jslib/jquery-1.10.2.js"></script>
    <script src="../jslib/bootstrap-3.3.4/js/bootstrap.min.js"></script>

    <script src="../jslib/db2js/dataset.js"></script>
    <script src="../jslib/db2js/render.js"></script>
    <script src="../jslib/db2js/renderers.js"></script>
    <script src="../jslib/db2js/pipelines.js"></script>
    <script src="../jslib/db2js/collector.js"></script>

    <script src="../jslib/molecule.js"></script>


</head>
<body>
    <table>
        <tr>
    		<!-- 可排序的列头，<th col=xxx text=xxx [renderer=xxx,默认为 std] sortable="true|false"></th> -->
            <th molecule-def="Header" renderer="std">
                <a></a>
                <script id="molecule">
                    // MOLECULE_DEF
                    var Header = function () {
                        var table = this.container.closest('[table]').attr('table');
                        var col = this.container.attr('col');
                        var text = this.container.attr('text');
                        this.container.attr('data-t', 'rows,N,' + col);

                        var sortable = this.container.attr('sortable');
                        sortable = (sortable && sortable != 'false')
                        
                        if(sortable){
	                        var a = this.container.find('a');
	                        a.attr('data', '#' + table);
	                        a.attr('renderer', "sortLink('" + col + "','" + text + "')");
                        } else {
                        	a.outerHtml(text);
                        }
                    }
                    db2js.Renderers.sortLink = function (colName, text) {
                        return function (element, table) {
                            var e = $(element);
                            e.attr('href', '###');
                            element.onclick = function () {
                                var sort = {};
                                var old = table.search._sorts && table.search._sorts[colName];
                                if (old == 'asc') {
                                    sort[colName] = 'desc';
                                } else {
                                    sort[colName] = 'asc';
                                }
                                table.search._sorts = sort;
                                table.load();
                            };
                            var icon = null;
                            var sorts = table.search._sorts || {};
                            switch (sorts[colName]) {
                                case 'asc': icon = 'glyphicon glyphicon-arrow-up'; break;
                                case 'desc': icon = 'glyphicon glyphicon-arrow-down'; break;
                            }
                            e.html(text + (icon ? '<span class="' + icon + '">' : ''));
                        }
                    }
                    // MOLECULE_DEF_END
                    Molecule.create(Header, document.currentScript);
                </script>
            </th>
            
            <!-- 树的缩进节点，<th col=xxx text=xxx></th> -->
            <th molecule-def="TreeNode" renderer="treeNode">
              	<script id="molecule">
                    // MOLECULE_DEF
                    var TreeNode = function () {
                        var table = this.container.closest('[table]').attr('table');
                        var col = this.container.attr('col');
                        var text = this.container.attr('text');
                        this.container.attr('data-n', 'row,' + col);
                        this.container.html(text);
                    }
                    
                	db2js.Renderers.treeNode = function (element, v, node, _1, row) {
                		var path = row.path;
                		var depth = node.depth
                		var s = '';
                		for(var i=0; i<depth; i++) s+= '&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'
                		var checkHtml = typeof node.checked != 'undefined' ? '<input type="checkbox">&nbsp;&nbsp;' : '';
                		if(node.children.length == 0){
                			$(element).html(s + checkHtml + v);
                		} else {
                			if(node.expanded){
                				$(element).html(s + '<a class=""><span class="glyphicon glyphicon-menu-down"></span></a>&nbsp;&nbsp;' + checkHtml + v);
                				$(element).find('a').on('click', function(){
                					node.expanded = false;
                					db2js.render(element.closest('table')[0]);
                				})
                			} else {
                				$(element).html(s + '<a class=""><span class="glyphicon glyphicon-menu-right"></span></a>' + checkHtml + v);
                				$(element).find('a').on('click', function(){
                					node.expanded = true;
                					db2js.render(element.closest('table')[0]);
                				})
                			}
                		}
                		if(typeof node.checked != 'undefined')
                			$(element).find('input[type=checkbox]').prop('checked', node.checked);
                		
                		$(element).find('input[type=checkbox]').on('change', function(){
                			var checked = this.checked;
                			var update = false;
                			(function down(node){
                				node.checked = checked; 
                				if(node.children.length) {
                					update = true;
                					node.children.forEach(down);
                				}
                			})(node);
                			(function up(pnode){
                				if(pnode == null) return;
                				if(checked && pnode.children.every(function(c){return c.checked == true})) {
                					update = true;
                					pnode.checked = true;
                					up(pnode.parent)
                				} else if(!checked && pnode.children.every(function(c){return c.checked === false})) {
                					pnode.checked = false;
                					update = true;
                					up(pnode.parent)
                				}
                			})(node.parent);
                			
                			if(update){
                				db2js.render(element.closest('table')[0]);
                			}
                		})
                	};
                    // MOLECULE_DEF_END
                    Molecule.create(TreeNode, document.currentScript);
                </script>
           	</th>
            
        </tr>
    </table>
    
    <!-- 树，<table table=xxx [paging="true"] [checkable="false"]></table> -->
    <table molecule-def="Tree" class="table table-striped" renderer="tree" paging="true" checkable="false">
        <!-- {INNER_HTML} -->
        <tfoot>
            <tr>
                <td width="100%" colspan="1000">
                    <nav class="text-center">
                        <ul class="pagination" renderer="pagination" />
                    </nav>
                </td>
            </tr>
        </tfoot>
        <script id="molecule">
            // MOLECULE_DEF
            function Tree() {
                var table = this.container.closest('[table]').attr('table');
                this.container.attr('data', '#' + table);
                var paging = this.container.attr('paging');
                if (paging == 'false') {
                    this.container.find('.pagination').closest('tfoot').remove();
                } else {
                	this.container.find('.pagination').attr('data', '#' + table);
                }
            }
            db2js.Renderers.tree = function(hTable, table){
        		var checkable = hTable.getAttribute('checkable');
        		checkable = (checkable && checkable != 'false');	
        		var tree = table.tree || buildTree(table);
        		
        		function buildTree(table){
        			var roots = table.rows.filter(function(row){
        				return table.find('id', row.parent_id) == null;		// 没有父节点的即是根节点
        			}).map(function (row){return toNode(row, 0)});				
        			
        			function toNode(row, depth, parentNode){
        				var node = {row: row, expanded: true, depth : depth, parent : parentNode};
        				node.children = table.rows
        							.filter(function(crow){return crow.parent_id == row.id})
        							.map(function(crow){return toNode(crow, depth + 1, node)});
        				if(checkable){
        					node.checked = false;		// false | true | undefined
        				}
        				return node;
        			}
        			
        			return table.tree = roots;
        		}
        		
        		
        		var columnRenders = [];
        		var headRow = hTable.tHead.rows[0];
        		for(var i=0; i<headRow.cells.length; i++){
        			var cell = headRow.cells[i];
        			var attrs = {};
        			for(var j=0; j<cell.attributes.length; j++){
        				var attr = cell.attributes[j].name;
        				var v = $(cell).attr(attr);
        				switch(attr){
        				case 'data-t' : attrs['data'] = v; break;
        				default : attrs[attr] = v;
        				} 
        			}
        			columnRenders.push(attrs);
        		}
        		
        		if(hTable.tBodies.length == 0){
        			var tBody = hTable.createTBody();
        		} else {
        			var tBody = hTable.tBodies[0];
        			while(tBody.rows.length){
        				tBody.rows[0].remove();
        			}
        		}
        		
        		var stk = tree.slice(); stk.reverse();
        		while(stk.length){
        			var nd = stk.pop();
        			var idx = nd.row._table.rows.indexOf(nd.row);
        			
        			var tr = tBody.insertRow();
        			columnRenders.forEach(function(column){
        				var cell = document.createElement('td');
        				var isTreeNode = false;
        				for(var attr in column){if(column.hasOwnProperty(attr)){
        					if(attr == 'data'){
        						$(cell).attr('data', hTable.getAttribute('data') + ',' + column.data.replace(/,\s*N\s*,/, ',' + (idx) + ','));
        					} else if(attr == 'data-n'){
        						$(cell).attr('data', column[attr]);
        						isTreeNode = true;
        					} else {
        						$(cell).attr(attr, column[attr]);
        					}
        				}}
        				tr.appendChild(cell);
        				if(isTreeNode) db2js.render(cell, nd, true);
        			});
        			
        			if(nd.expanded){
        				for(var i = nd.children.length-1; i >= 0; i--){
        					stk.push(nd.children[i]);
        				}
        			}
        		}
        	}
            // MOLECULE_DEF_END
            Molecule.create(Tree, document.currentScript);
        </script>
    </table>

    <div molecule="TableList" table="company" edit-dialog="dialog1">
        <h1>表格编辑</h1>
        <div>
            <form class="form-inline text-right">
                <div molecule="SearchFormItem" col="name" text="Name">
                    <input type="text" molecule="SearchInput">
                </div>
                <button molecule="SearchButton">Search</button>
                <button molecule="AddButton">Add</button>                
            </form>
        </div>
        <div molecule="TableError"></div>

        <table molecule="Tree" checkable="true">
            <thead>
                <tr>
                    <th molecule="TreeNode" col="name" text="Name"></th>
                    <th molecule="SortHeader" col="email" text="Email"></th>
                    <th data-t="rows,N,id" renderer="editLink"></th>
                </tr>
            </thead>
        </table>

    </div>

    <div molecule="Dialog" title="Company" id="dialog1" table="company">
        <form>
            <div molecule="FormItem" col="name" text="Name">
                <input type="text" molecule="Input">
            </div>
            <div molecule="FormItem" col="email" text="Email">
                <input type="email" molecule="Input">
            </div>
        </form>
    </div>

</body>
<script>

    var table = new db2js.DataTable('company', 'test.dbjs', { pageSize: 5 });
    table.on('load', function (error) {
        db2js.render(null, this);
    });

    $(function(){
	    table.fill([
	        {id : 1, name : '东方航空', email : 'dh@xxx.com', parent_id : null},
	        {id : 2, name : '东方航空华东公司', email : 'dh@xxx.com', parent_id : 1},
	        {id : 8, name : '空管部', email : 'dh@xxx.com', parent_id : 2},
	        {id : 3, name : '信息部', email : 'dh@xxx.com', parent_id : 2},
	        {id : 4, name : '东方航空华北公司', email : 'dh@xxx.com', parent_id : 1},
	        {id : 5, name : '厦门航空', email : 'dh@xxx.com', },
	        {id : 6, name : '厦门航空华南公司', email : 'dh@xxx.com', parent_id : 5},
	        {id : 7, name : '吉祥航空', email : 'dh@xxx.com'},
	    ], true);
    });
</script>
</html>